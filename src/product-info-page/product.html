<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Information | QR Farm</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .product-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .product-header {
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            margin-bottom: 15px;
        }
        .product-info {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 10px;
        }
        .info-label {
            font-weight: bold;
        }
        .logo {
            text-align: center;
            margin-bottom: 20px;
        }
        .logo h1 {
            color: #0a7ea4;
            margin: 0;
        }
        .journey-timeline {
            margin-top: 30px;
        }
        .timeline {
            position: relative;
            max-width: 100%;
            margin: 20px auto;
        }
        .timeline::after {
            content: '';
            position: absolute;
            width: 6px;
            background-color: #0a7ea4;
            top: 0;
            bottom: 0;
            left: 18px;
            margin-left: -3px;
        }
        .timeline-item {
            padding: 10px 40px;
            position: relative;
            background-color: inherit;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 15px;
        }
        .timeline-item::after {
            content: '';
            position: absolute;
            width: 25px;
            height: 25px;
            left: 12px;
            background-color: white;
            border: 4px solid #0a7ea4;
            border-radius: 50%;
            z-index: 1;
            top: 15px;
        }
        .timeline-content {
            padding: 15px;
            background-color: white;
            position: relative;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .timeline-title {
            font-weight: bold;
            color: #0a7ea4;
            margin-bottom: 10px;
        }
        .timeline-details {
            margin-bottom: 5px;
        }
        .qr-section {
            margin-top: 30px;
            text-align: center;
        }
        .qr-code {
            display: block;
            margin: 0 auto;
            max-width: 200px;
            height: auto;
            margin-top: 20px;
        }
        .back-link {
            display: inline-block;
            margin-top: 20px;
            padding: 8px 15px;
            background-color: #0a7ea4;
            color: white;
            text-decoration: none;
            border-radius: 4px;
        }
        .batch-journey {
            margin-top: 40px;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }

        .batch-journey .timeline::after {
            background-color: #4a9d5e; /* Different color for batch timeline */
        }

        .batch-journey .timeline-item::after {
            border-color: #4a9d5e; /* Different color for batch timeline markers */
        }

        .batch-journey .timeline-title {
            color: #4a9d5e; /* Different color for batch timeline titles */
        }

        .timeline-indicator {
            display: inline-block;
            margin-left: 5px;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            color: white;
        }

        .product-indicator {
            background-color: #0a7ea4;
        }

        .batch-indicator {
            background-color: #4a9d5e;
        }

        .recipe-section {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .recipe-card {
            border-left: 4px solid #4a9d5e;
            padding: 10px 15px;
            margin-bottom: 15px;
            background-color: #f9f9f9;
            border-radius: 0 5px 5px 0;
        }

        .recipe-title {
            font-weight: bold;
            color: #4a9d5e;
            margin-bottom: 5px;
        }

        .recipe-description {
            font-size: 14px;
            line-height: 1.4;
        }

        #refresh-recipes {
            background-color: #4a9d5e;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        #refresh-recipes:hover {
            background-color: #3a8d4e;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <h1>QR Farm</h1>
            <p>Product Information</p>
        </div>
        
        <div id="product-display" class="product-card">
            <div class="product-header">
                <h2 id="product-id">Loading product information...</h2>
            </div>
            <div id="product-content">
                <!-- Product data will be inserted here -->
            </div>
        </div>
        
        <div class="journey-timeline">
            <h2>Product Journey</h2>
            <p>Follow this product's complete journey:</p>
            
            <div id="timeline" class="timeline">
                <!-- Timeline items will be inserted here -->
                <p id="timeline-loading">Loading product journey...</p>
            </div>
        </div>
        
        <div class="journey-timeline batch-journey">
            <h2>Batch Journey</h2>
            <p>Traceability information of the entire batch this product belongs to:</p>
            
            <div id="batch-timeline" class="timeline">
                <!-- Batch timeline items will be inserted here -->
                <p id="batch-timeline-loading">Loading batch journey...</p>
            </div>
        </div>
        
        <div class="qr-section">
            <h2>Share This Product</h2>
            <p>Scan this QR code to view this product on another device</p>
            <div id="qr-container">
                <!-- QR code will be inserted here -->
            </div>
        </div>

        <div class="recipe-section">
            <h2>What can you make with this?</h2>
            <p id="recipe-loading">Loading recipe ideas...</p>
            <div id="recipe-suggestions" style="display: none;">
                <!-- Recipe suggestions will appear here -->
            </div>
            <button id="refresh-recipes" style="display: none;">More Ideas</button>
        </div>
        
        <div style="text-align: center; margin: 30px 0;">
            <a href="./index.html" class="back-link">Back to Home</a>
        </div>
    </div>
    <script type="module">
  import { getProduct, getBatch, getRecipeSuggestions as fetchRecipeSuggestions } from './api.js';
  
  document.addEventListener('DOMContentLoaded', async function() {
    // Get product ID from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');
    
    if (!productId) {
      showError("Product ID not found in URL. Please use format: product.html?id=PROD-XXX");
      return;
    }
    
    try {
      // Get product data
      const productData = await getProduct(productId);
      const batchData = await getBatch(productData.batchId);
      
      // Display product data
      displayProductData(productData, batchData.productType);
      
      // Display product journey
      displayProductJourney(productData);
      
      // Now also fetch and display the batch journey
      if (productData.batchId) {
        // Display batch journey using the already fetched batchData
        displayBatchJourney(batchData);
      }
      
      // Generate QR code for sharing
      generateQRCode(productId);
    } catch (error) {
      console.error('Error loading product data:', error);
      showError(`Error loading product data: ${error.message}`);
    }
  });

  // Replace the fetchProductData function with this refactored version
  async function fetchProductData(productId) {
    try {
      // Show loading state
      document.getElementById('product-id').textContent = 'Loading product information...';
      
      // Get product data using the imported API function
      const productData = await getProduct(productId);
      
      // Display product data
      displayProductData(productData);
      
      // Display product journey
      displayProductJourney(productData);
      
    } catch (error) {
      console.error('Error fetching product data:', error);
      showError("Error loading product data. " + error.message);
    }
  }

        function displayProductData(product, productType) {
            const productId = product._id || product.id;
            document.getElementById('product-id').textContent = `Product: ${productId}`;
        
            // Find initial product details from the first block
            const initialBlock = product.blocks && product.blocks.length > 0 
                ? product.blocks[0] 
                : null;
                    
            const details = initialBlock?.data?.productDetails || {};
            
            const content = document.getElementById('product-content');
            content.innerHTML = `
                <div class="product-info">
                    <span class="info-label">Batch ID:</span>
                    <span>
                        ${product.batchId || 'Unknown'} 
                        <a href="./batch.html?id=${product.batchId}" style="color: #0a7ea4; margin-left: 5px;">
                            View entire batch
                        </a>
                    </span>
                    
                    <span class="info-label">Product Type:</span>
                    <span>${productType || 'Unknown'}</span>
                    
                    <span class="info-label">Weight:</span>
                    <span>${details.weight || product.weight || 'N/A'} kg</span>
                    
                    <span class="info-label">Size:</span>
                    <span>${details.size || product.size || 'N/A'}</span>
                    
                    ${details.quality || product.quality ? 
                      `<span class="info-label">Quality:</span>
                       <span>${details.quality || product.quality}</span>` : ''}
                    
                    ${product.additionalNotes || details.notes ? 
                      `<span class="info-label">Notes:</span>
                       <span>${product.additionalNotes || details.notes}</span>` : ''}
                       
                    <span class="info-label">Created:</span>
                    <span>${initialBlock ? formatDate(initialBlock.timestamp) : 'Unknown'}</span>
                </div>
            `;

            if (productType && productType !== 'Unknown') {
                loadRecipeSuggestions(productType);
            } else {
                document.getElementById('recipe-loading').textContent = 
                'Product type unknown. Cannot suggest recipes.';
            }
        
        }
        
        function displayProductJourney(product) {
            const timeline = document.getElementById('timeline');
            
            // Remove loading message
            document.getElementById('timeline-loading').remove();
            
            if (!product.blocks || product.blocks.length === 0) {
                timeline.innerHTML = '<p>No journey data available for this product</p>';
                return;
            }
            
            if(!validateChain(product.blocks)) {
                showError("Product journey data is corrupted. Please contact support.");
                return;
            }

            let timelineHTML = '';
            
            product.blocks.forEach((block, index) => {
                timelineHTML += `
                    <div class="timeline-item">
                        <div class="timeline-content">
                            <div class="timeline-title">
                                ${getStepTitle(block.actorType)} (Step ${index + 1})
                                <span class="timeline-indicator product-indicator">Product</span>
                            </div>
                            <div class="timeline-details"><strong>Actor:</strong> ${block.actor}</div>
                            <div class="timeline-details"><strong>Location:</strong> ${block.location}</div>
                            <div class="timeline-details"><strong>Date:</strong> ${formatDate(block.timestamp)}</div>
                            ${block.data ? 
                              `<div class="timeline-details"><strong>Details:</strong> ${formatBlockData(block.data)}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            timeline.innerHTML = timelineHTML;
        }
        
        function formatBlockData(data) {
            if (!data) return 'No details available';
            
            if (typeof data === 'string') return data;
            
            let result = '';
            
            if (data.action) {
                result += `Action: ${data.action}. `;
            }
            
            if (data.details) {
                result += data.details;
            }
            
            if (data.productDetails) {
                const details = data.productDetails;
                result += Object.keys(details).map(key => 
                    `${key.charAt(0).toUpperCase() + key.slice(1)}: ${details[key]}`
                ).join(', ');
            }
            
            return result || 'No specific details';
        }
        
        function getStepTitle(actorType) {
            switch(actorType) {
                case 'producer': return 'Production';
                case 'importer': return 'Import Processing';
                case 'trader': return 'Distribution';
                case 'retailer': return 'Retail';
                default: return 'Processing';
            }
        }
        
        function generateQRCode(productId) {
            // Get the container
            const qrContainer = document.getElementById('qr-container');
            
            // Create a URL for this product page
            const productUrl = window.location.href;
            
            // For simplicity, we'll use a QR code service that returns an image
            // In production, you might want to use a library like qrcode.js
            const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(productUrl)}`;
            
            // Create and add the image
            const qrImage = document.createElement('img');
            qrImage.src = qrCodeUrl;
            qrImage.alt = `QR Code for ${productId}`;
            qrImage.className = 'qr-code';
            
            qrContainer.appendChild(qrImage);
        }
        
        function formatDate(dateInput) {
            if (!dateInput) return 'Unknown';
            
            let date;
            if (typeof dateInput === 'number') {
                date = new Date(dateInput);
            } else {
                date = new Date(dateInput);
            }
            
            if (isNaN(date.getTime())) {
                return String(dateInput);
            }
            
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }
        
        function showError(message) {
            const productDisplay = document.getElementById('product-display');
            productDisplay.innerHTML = `<div class="error-message" style="color: red; padding: 20px; text-align: center;">${message}</div>`;
        }

        function displayBatchJourney(batch) {
            const batchTimeline = document.getElementById('batch-timeline');

            if(!validateChain(batch.blocks)) {
                showError("Product journey data is corrupted. Please contact support.");
                return;
            }
            
            // Remove loading message
            document.getElementById('batch-timeline-loading').remove();
            
            if (!batch.blocks || batch.blocks.length === 0) {
                batchTimeline.innerHTML = '<p>No journey data available for this batch</p>';
                return;
            }
            
            let timelineHTML = '';
            
            batch.blocks.forEach((block, index) => {
                timelineHTML += `
                    <div class="timeline-item">
                        <div class="timeline-content">
                            <div class="timeline-title">
                                ${getBlockTitle(block)}
                                <span class="timeline-indicator batch-indicator">Batch</span>
                            </div>
                            <div class="timeline-details"><strong>Actor:</strong> ${block.actor}</div>
                            <div class="timeline-details"><strong>Location:</strong> ${block.location}</div>
                            <div class="timeline-details"><strong>Date:</strong> ${formatDate(block.timestamp)}</div>
                            ${block.data?.stageName ? `<div class="timeline-details"><strong>Stage:</strong> ${block.data.stageName}</div>` : ''}
                            ${block.data?.notes ? `<div class="timeline-details"><strong>Notes:</strong> ${block.data.notes}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            batchTimeline.innerHTML = timelineHTML;
        }

        // Add this new helper function
        function getBlockTitle(block) {
            if (block.data?.stageName) {
                return block.data.stageName;
            }
            
            if (block.data?.action) {
                switch(block.data.action) {
                    case 'batch_created': return 'Batch Created';
                    case 'batch_updated': return 'Batch Updated';
                    case 'batch_completed': return 'Batch Completed';
                    default: return block.data.action;
                }
            }
            
            return `Processing Step ${block.blockId + 1}`;
        }

        // Replace this function
        function calculateHash(blockId, prevHash, data, timestamp) {
            // Use the block's original timestamp for hash calculation
            // This matches how the hash was originally calculated in React Native
            const dataToHash = `${blockId}:${prevHash}:${data}:${timestamp}`;
            
            // This is the same simplified hash algorithm from create-qr.tsx
            return Array.from(dataToHash)
                .reduce((hash, char) => {
                    const charCode = char.charCodeAt(0);
                    hash = (hash ^ (charCode + ((hash << 5) - hash))) | 0; // force int32
                    return hash;
                }, 0)
                .toString(16);
        }

        function validateChain(blocks) {
        // Chain must have at least one block
        if (!blocks || blocks.length === 0) return true;
        
            for (let i = 1; i < blocks.length; i++) {
                const currentBlock = blocks[i];
                const previousBlock = blocks[i-1];
                
                // Check if prevHash matches previous block's hash
                if (currentBlock.prevHash !== previousBlock.hash) {
                console.error(`Chain broken at block ${i}: prevHash mismatch`);
                console.error(`Expected: ${previousBlock.hash}, Found: ${currentBlock.prevHash}`);
                return false;
                }

                // // Recalculate hash to verify block data hasn't been changed
                // // IMPORTANT: Pass the block's original timestamp to match original hash calculation
                // const recalculatedHash = calculateHash(
                // currentBlock.blockId,
                // currentBlock.prevHash,
                // JSON.stringify(currentBlock.data),
                // currentBlock.timestamp  // Use the block's original timestamp
                // );

                // if (recalculatedHash !== currentBlock.hash) {
                // console.error(`Chain broken at block ${i}: hash verification failed`);
                // return false;
                // }
            }
        
        return true;
        }

        // Add this to your existing script
        async function loadRecipeSuggestions(productType) {
          const recipeLoading = document.getElementById('recipe-loading');
          const recipeSuggestions = document.getElementById('recipe-suggestions');
          const refreshButton = document.getElementById('refresh-recipes');
          
          try {
            // Use the imported API function
            const data = await fetchRecipeSuggestions(productType);
            // For testing, use the mock function
            //const recipeMockData = await mockRecipes(productType);
            // Display the recipes
            recipeLoading.style.display = 'none';
            recipeSuggestions.style.display = 'block';
            refreshButton.style.display = 'inline-block';
            
            displayRecipes(data);
            
            // Set up refresh button
            refreshButton.onclick = () => loadRecipeSuggestions(productType);
            
          } catch (error) {
            console.error('Error fetching recipe suggestions:', error);
            recipeLoading.textContent = 'Could not load recipe suggestions. Try again later.';
          }
        }
  
        function displayRecipes(data) {
          const recipeSuggestions = document.getElementById('recipe-suggestions');
          
          // Clear previous suggestions
          recipeSuggestions.innerHTML = '';
          
          if (!data.recipes || data.recipes.length === 0) {
            recipeSuggestions.innerHTML = `<p>No recipe suggestions available for ${data.ingredient}.</p>`;
            return;
          }
          
          // Add each recipe
          data.recipes.forEach(recipe => {
            const recipeCard = document.createElement('div');
            recipeCard.className = 'recipe-card';
            
            recipeCard.innerHTML = `
              <div class="recipe-title">${recipe.title}</div>
              <div class="recipe-description">${recipe.description}</div>
            `;
            
            recipeSuggestions.appendChild(recipeCard);
          });
        }
    </script>
</body>
</html>