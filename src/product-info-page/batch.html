<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch Information | QR Farm</title>
    <style>
        /* Base styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .shipment-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .shipment-header {
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            margin-bottom: 15px;
        }
        .shipment-info {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 10px;
        }
        .info-label {
            font-weight: bold;
        }
        .logo {
            text-align: center;
            margin-bottom: 20px;
        }
        .logo h1 {
            color: #0a7ea4;
            margin: 0;
        }
        
        /* Products list styles */
        .products-container {
            margin-top: 30px;
        }
        .products-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .product-item {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .product-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .product-id {
            font-weight: bold;
            color: #0a7ea4;
            margin-bottom: 10px;
        }
        .product-detail {
            font-size: 14px;
            margin: 5px 0;
        }
        .view-product {
            display: inline-block;
            margin-top: 10px;
            padding: 5px 10px;
            background-color: #0a7ea4;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 14px;
        }
        
        /* Summary styles */
        .journey-summary {
            margin-top: 30px;
        }
        .summary-card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        .summary-step {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .step-number {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 30px;
            height: 30px;
            background-color: #0a7ea4;
            color: white;
            border-radius: 50%;
            margin-right: 15px;
            font-weight: bold;
        }
        .step-content {
            flex: 1;
        }
        .step-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        /* Tabs for navigation */
        .tabs {
            display: flex;
            margin-top: 30px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            background-color: #f5f5f5;
        }
        .tab.active {
            background-color: white;
            border-color: #ddd;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <h1>QR Farm</h1>
            <p>Shipment & Batch Information</p>
        </div>
        
        <div id="shipment-display" class="shipment-card">
            <div class="shipment-header">
                <h2 id="shipment-id">Loading batch information...</h2>
            </div>
            <div id="shipment-content">
                <!-- Shipment data will be inserted here -->
            </div>
        </div>
        
        <!-- Tabs for navigation -->
        <div class="tabs">
            <div class="tab active" data-tab="products">Products</div>
            <div class="tab" data-tab="journey">Journey Summary</div>
        </div>
        
        <!-- Products List Tab -->
        <div id="products-tab" class="tab-content active">
            <div class="products-container">
                <h2>Products in this Shipment</h2>
                <p id="products-count">Loading products...</p>
                
                <div id="products-list" class="products-list">
                    <!-- Product items will be inserted here -->
                </div>
            </div>
        </div>
        
        <!-- Journey Summary Tab -->
        <div id="journey-tab" class="tab-content">
            <div class="journey-summary">
                <h2>Batch Journey Summary</h2>
                <p>Overview of the journey this entire batch has taken:</p>
                
                <div id="journey-summary" class="summary-card">
                    <!-- Journey summary will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <script type="module">
  import { getBatch, getBatchProducts } from './api.js';
  
  document.addEventListener('DOMContentLoaded', async function() {
    // Get batch ID from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const batchId = urlParams.get('id');
    
    if (!batchId) {
      showError("Invalid batch ID. Please use format: batch.html?id=BATCH-XXX");
      return;
    }
    
    // Set up tab navigation
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        // Remove active class from all tabs and contents
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // Add active class to clicked tab
        tab.classList.add('active');
        
        // Show corresponding content
        const tabName = tab.getAttribute('data-tab');
        document.getElementById(`${tabName}-tab`).classList.add('active');
      });
    });
    
    try {
      // Get batch data
      const batchData = await getBatch(batchId);
      displayBatchData(batchData);
      
      // Get products for this batch
      const products = await getBatchProducts(batchId);
      displayProductsList(products);
      
      // Generate journey summary
      generateJourneySummary(batchData);
    } catch (error) {
      console.error('Error loading data:', error);
      showError(`Error loading data: ${error.message}`);
    }
  });
  
  // Your existing display functions...
  function displayBatchData(batch) {
    document.getElementById('shipment-id').textContent = `Batch: ${batch._id || batch.id}`;

        const content = document.getElementById('shipment-content');
        content.innerHTML = `
            <div class="shipment-info">
                <span class="info-label">Product Type:</span>
                <span>${batch.productType}</span>
                
                <span class="info-label">Harvest Date:</span>
                <span>${formatDate(batch.harvestDate)}</span>
                
                <span class="info-label">Origin:</span>
                <span>${batch.location}</span>
                
                <span class="info-label">Responsible Staff:</span>
                <span>${batch.responsibleStaff}</span>
                
                <span class="info-label">Quantity:</span>
                <span>${batch.quantity} products</span>
                
                <span class="info-label">Status:</span>
                <span>${batch.status || 'Active'}</span>
            </div>
        `;
  }
  
  function displayProductsList(products) {
    const productsCount = document.getElementById('products-count');
        productsCount.textContent = `${products.length} products in this batch`;
        
        const productsList = document.getElementById('products-list');
        productsList.innerHTML = '';
        
        products.forEach(product => {
            const productId = product._id || product.id;
            
            // Use the data from the first block (producer info)
            const initialBlock = product.blocks && product.blocks.length > 0 
                ? product.blocks[0] 
                : null;
                
            const details = initialBlock?.data?.productDetails || {};
            
            const productEl = document.createElement('div');
            productEl.className = 'product-item';
            
            productEl.innerHTML = `
                <div class="product-id">${productId}</div>
                <div class="product-detail"><strong>Weight:</strong> ${details.weight || product.weight || 'N/A'} kg</div>
                <div class="product-detail"><strong>Size:</strong> ${details.size || product.size || 'N/A'}</div>
                ${details.quality || product.quality ? 
                  `<div class="product-detail"><strong>Quality:</strong> ${details.quality || product.quality}</div>` : ''}
                <a href="./product.html?id=${productId}" class="view-product">View Details</a>
            `;
            
            productsList.appendChild(productEl);
        });
  }
  
  function generateJourneySummary(batchData) {
    const journeySummary = document.getElementById('journey-summary');
        
        if (!batchData.blocks || batchData.blocks.length === 0) {
            journeySummary.innerHTML = '<p>No journey data available for this batch</p>';
            return;
        }

        if (!validateChain(batchData.blocks)) {
             showError("Invalid batch data. Please contact support.");
             showError(batchData.blocks.hash, batchData.blocks.prevHash);
             return;
        }
        
        let summaryHTML = '';
        
        batchData.blocks.forEach((block, index) => {
            summaryHTML += `
                <div class="summary-step">
                    <div class="step-number">${index + 1}</div>
                    <div class="step-content">
                        <div class="step-title">${getBlockTitle(block)}</div>
                        <div><strong>Actor:</strong> ${block.actor}</div>
                        <div><strong>Location:</strong> ${block.location}</div>
                        <div><strong>Date:</strong> ${formatDate(block.timestamp)}</div>
                        ${block.data?.stageName ? `<div><strong>Stage:</strong> ${block.data.stageName}</div>` : ''}
                        ${block.data?.notes ? `<div><strong>Notes:</strong> ${block.data.notes}</div>` : ''}
                    </div>
                </div>
            `;
        });
        
        journeySummary.innerHTML = summaryHTML;
  }
  
  // Rest of your functions (formatDate, showError, etc.)...
  function getBlockTitle(block) {
        if (block.data?.stageName) {
            return block.data.stageName;
        }
        
        if (block.data?.action) {
            switch(block.data.action) {
                case 'batch_created': return 'Batch Created';
                case 'batch_updated': return 'Batch Updated';
                case 'batch_completed': return 'Batch Completed';
                default: return block.data.action;
            }
        }
        
        return `Processing Step ${block.blockId + 1}`;
    }
    
    function getStepTitle(actorType) {
        switch(actorType) {
            case 'producer': return 'Production';
            case 'importer': return 'Import Processing';
            case 'trader': return 'Distribution';
            case 'retailer': return 'Retail';
            default: return 'Processing';
        }
    }
    
    function formatDate(dateInput) {
        if (!dateInput) return 'Unknown';
        
        let date;
        if (typeof dateInput === 'number') {
            date = new Date(dateInput);
        } else {
            date = new Date(dateInput);
        }
        
        if (isNaN(date.getTime())) {
            return String(dateInput);
        }
        
        return date.toLocaleDateString();
    }
    
    function showError(message) {
        const shipmentDisplay = document.getElementById('shipment-display');
        shipmentDisplay.innerHTML = `<div class="error-message" style="color: red; padding: 20px; text-align: center;">${message}</div>`;
    }
    
    // Add this function to your validateChain function
    function calculateHash(blockId, prevHash, data, timestamp) {
    // Use the block's original timestamp for hash calculation
    // This matches how the hash was originally calculated in React Native
    const dataToHash = `${blockId}:${prevHash}:${data}:${timestamp}`;
    
    // This is the same simplified hash algorithm from create-qr.tsx
    return Array.from(dataToHash)
        .reduce((hash, char) => {
            const charCode = char.charCodeAt(0);
            hash = (hash ^ (charCode + ((hash << 5) - hash))) | 0; // force int32
            return hash;
        }, 0)
        .toString(16);
    }

    function validateChain(blocks) {
    // Chain must have at least one block
    if (!blocks || blocks.length === 0) return true;
    
        for (let i = 1; i < blocks.length; i++) {
            const currentBlock = blocks[i];
            const previousBlock = blocks[i-1];

            console.log(`Validating block ${currentBlock.blockId}`);
            
            // Check if prevHash matches previous block's hash
            if (currentBlock.prevHash !== previousBlock.hash) {
            console.error(`Chain broken at block ${i}: prevHash mismatch`);
            console.error(`Expected: ${previousBlock.hash}, Found: ${currentBlock.prevHash}`);
            return false;
            }

            // Recalculate hash to verify block data hasn't been changed
            // IMPORTANT: Pass the block's original timestamp to match original hash calculation
            const recalculatedHash = calculateHash(
            currentBlock.blockId,
            currentBlock.prevHash,
            JSON.stringify(currentBlock.data),
            currentBlock.timestamp  // Use the block's original timestamp
            );
            
            console.log(`Original hash: ${currentBlock.hash}`);
            console.log(`Recalculated: ${recalculatedHash}`);

            // Add this to your validateChain function
            console.log('Block data for validation:', {
            blockId: currentBlock.blockId,
            prevHash: currentBlock.prevHash,
            data: JSON.stringify(currentBlock.data),
            timestamp: currentBlock.timestamp,
            originalHash: currentBlock.hash
            });

            if (recalculatedHash !== currentBlock.hash) {
            console.error(`Chain broken at block ${i}: hash verification failed`);
            return false;
            }
        }
    
    return true;
    }

</script>
</body>
</html>